#!groovy

pipeline {
	agent {label "devel8"}
	parameters {
		string(name: "dockerTag", defaultValue: "DOCKER_TAG_NOT_SET")
		string(name: "deployEnvironment", defaultValue: "staging")
	}
	environment {
		MARATHON_TOKEN = credentials("METASCRUM_MARATHON_TOKEN")
	}
	options {
		timestamps()
	}
	stages {
		stage("deploy") {
			steps {
				println("deploying with docker tag: ${params.dockerTag}")
				dir("deploy") {
					git(url: "https://git.dbc.dk/dataio/deploy")
					sh """#!/usr/bin/env bash
						set -xe
						virtualenv -p python3 ENV
						source ENV/bin/activate
						python3 \$(which pip3) install --upgrade pip
						python3 \$(which pip3) install -U -e \"git+https://github.com/DBCDK/mesos-tools.git#egg=mesos-tools\"

						rm -rf instances
						mkdir instances
						find marathon/ -wholename \\*dbc-\\*/${params.deployEnvironment}/\\*.instance -exec sh -c 'python3 \$(which marathon-config-producer) {} --root marathon --template-keys DOCKER_TAG=${params.dockerTag} -o instances/"\$(basename {})".json' \\;
						find instances -type f | parallel -j2 python3 \$(which marathon-deployer) deploy {} -a $MARATHON_TOKEN -b https://mcp1.dbc.dk:8443
					"""
				}
				build job: "dataio/dataio-tracerbullet-staging", wait: false
			}
		}
	}
}
