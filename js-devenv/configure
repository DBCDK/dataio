#!/usr/bin/env bash
#
# DataIO - Data IO
# Copyright (C) 2015 Dansk Bibliotekscenter a/s, Tempovej 7-11, DK-2750 Ballerup,
# Denmark. CVR: 15149043
#
# This file is part of DataIO.
#
# DataIO is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# DataIO is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with DataIO.  If not, see <http://www.gnu.org/licenses/>.
#

MASTER_PROJECT=acceptance-tester
BUILD_NUMBER=`curl --silent http://is.dbc.dk/job/${MASTER_PROJECT}/lastSuccessfulBuild/buildNumber`
BUILDSCRIPT_DIR=/usr/local/lib/is.dbc.dk
JAIL_DIR=testarea

echo "using build ${BUILD_NUMBER} of master project ${MASTER_PROJECT}"

rm -rf ${JAIL_DIR}
mkdir ${JAIL_DIR}
cd ${JAIL_DIR}

# Start port allocator
BUILD_ID=dontKillMe ${BUILDSCRIPT_DIR}/port_allocator_service_daemon.py

VENV=`pwd`/ENV
EGGS=`pwd`/dependencies
rm -f dependencies.txt
rm -f ${EGGS}/*

if [ ! -z ${JENKINS_CREDENTIALS} ]; then
    # JENKINS_CREDENTIALS is set and is not the empty string
    # Prepend the -c option for the dependency manager
    JENKINS_CREDENTIALS="-c ${JENKINS_CREDENTIALS}" 
fi

DEPENDENCY_MANAGER=$BUILDSCRIPT_DIR/dependency_manager/bin/dependency-manager
${DEPENDENCY_MANAGER} ${MASTER_PROJECT} ${BUILD_NUMBER} ${JENKINS_CREDENTIALS}
${DEPENDENCY_MANAGER} ${MASTER_PROJECT} ${BUILD_NUMBER} -a testrunner-jsshell-convert --verbose ${JENKINS_CREDENTIALS}
${DEPENDENCY_MANAGER} --download ${EGGS} --pattern ".*\.(egg)$" --verbose ${JENKINS_CREDENTIALS}

${BUILDSCRIPT_DIR}/envbuilder.sh -v -s -f -e ${VENV} ${EGGS}
cd ..

## pip install missing stuff 
JAIL_DIR=testarea
cd ${JAIL_DIR}

source ENV/bin/activate
# workaround for http://bugs.dbc.dk/show_bug.cgi?id=21148 which is probably related to https://github.com/pypa/virtualenv/issues/596
# interpreter paths are sometimes truncated when multiple jenkins builds are running at the same time
PIPBIN=$(realpath $(which pip))
python $PIPBIN install configobj pexpect nose lxml
deactivate 
exit 0
